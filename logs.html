---
title: Logs
author: James Daly
email: j.daly.2015@my.bristol.ac.uk
comments: false
---

{% assign logs = site.data.logs %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>{{ page.title }}</title>
        
    <link rel="stylesheet" href="/assets/main.css">
  </head>
  <body>
    <main>
      <section class="mark">
        <a href="/">{% include mark.svg %}</a>
      </section>

      <section>
        <article>
          <h1>{{ page.title }}</h1>

      {%- for log in logs -%}
          <div class="card">
            <h3>{{ log[0] }}</h3>

            <div class="data" data-log="{{ log[0] }}">
          {%- for day in log[1] -%}
            <input type="checkbox" title="{{ day[0] }}" {% if day[1] %}checked{% endif %} disabled />
          {%- endfor -%}
            </div>
          </div>
      {%- endfor -%}
        </article>
      </section>
      <section>
        <div id="toolbar"/>
      </section>
    </main>

    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script async type="text/javascript">
      let data = {
      {%- for log in logs -%}
        '{{ log[0] }}': {
        {%- for day in log[1] -%}
          '{{ day[0] }}': {{ day[1] }},
        {%- endfor -%}
        },
      {%- endfor -%}
      }

      const dt = new Date()
      const ds = '' + dt.getUTCFullYear() + ('00' + (dt.getUTCMonth() + 1)).slice(-2) + ('00' + dt.getUTCDate()).slice(-2)

      let eque = []
      let savable = {}

      const deque = () => {
        let e = eque.shift()
        console.log('deque', e)
        let log = e.target.parentNode.getAttribute('data-log')
        let item = e.target.getAttribute('title')
        let user = netlifyIdentity.currentUser()

        if (/*user && */e.set) {
          for (let setop in e.set) {
            if (typeof e.set[setop] === 'boolean') {
              e.target[setop] = e.set[setop]
              if (!savable[log]) savable[log] = {}
              if (typeof savable[log][item] === 'undefined') savable[log][item] = e.set[setop]
              else if (!e.force) {
                delete savable[log][item]
                if (!Object.keys(savable[log]).length) delete savable[log]
              }
            } else {
              console.error('unknown setop', e)
            }
          }
        } else if (!user && e.unset) {
          for (let setop in e.unset) {
            if (typeof e.unset[setop] === 'boolean') {
              e.target[setop] = e.unset[setop]
            } else {
              console.error('unknown unsetop', e)
            }
          }
        }

        e.target.indeterminate = false
        updateSavable()
      }

      const save = async (data, updates) => {
        let data2 = { ...data }
        for (const key in updates) data2[key] = {
          ...data2[key],
          ...updates[key]
        }

        console.log('save', data2)

        let yaml = Object.keys(data2)
          .reduce((a, k) => `${a}\n'${k}':\n${
            Object.keys(data2[k])
              .reduce((a, k2) => `  ${k2}: ${data2[k][k2]}\n${a}`, '')
          }`, '')

        console.log(`save :: rebuilt _data/logs.yaml: %c${yaml}`, 'color: #777')

        const jwt = await netlifyIdentity.currentUser().jwt()
        const headers = {
          Authorization: `Bearer ${jwt}`,
          'Content-Type': 'application/json',
        }


        console.log('save :: getting ref master...')
        let res = await fetch('https://mrvs.city/.netlify/git/github/git/refs/heads/master', { headers })
        const ref = await res.json()

        if (!ref.object || ref.object.type !== 'commit' || !ref.object.sha) throw `bad ref heads/master`

        console.log(`save :: getting commit ${ref.object.sha}...`)
        res = await fetch(`https://mrvs.city/.netlify/git/github/git/commits/${ref.object.sha}`, { headers })
        const commit = await res.json()

        if (!commit.tree || !commit.tree.sha) throw `bad commit ${ref.object.sha}`

        console.log(`save :: getting tree ${commit.tree.sha} for commit...`)
        res = await fetch(`https://mrvs.city/.netlify/git/github/git/trees/${commit.tree.sha}`, { headers })
        const tree = await res.json()

        if (!tree.tree) throw `bad tree ${commit.tree.sha}`
        const dir = tree.tree.find(e => e.path === '_data' && e.type === 'tree')
        if (!dir) throw `_data not found ${tree.sha}`

        console.log(`save :: getting subtree ${dir.sha} for _data/...`)
        res = await fetch(`https://mrvs.city/.netlify/git/github/git/trees/${dir.sha}`, { headers })
        const subtree = await res.json()

        if (!subtree.tree) throw `bad tree ${tree.sha}`
        const file = subtree.tree.find(e => e.path === 'logs.yaml' && e.type === 'blob')
        if (!file) throw `logs.yaml not found ${subtree.sha}`

        
        console.log(`save :: creating new blob for logs...`)
        res = await fetch(`https://mrvs.city/.netlify/git/github/git/blobs`, {
          method: 'POST',
          headers,
          body: JSON.stringify({ content: yaml })
        })
        const new_blob = await res.json()

        if (!new_blob.sha) throw `bad new blob ${JSON.stringify(new_blob)}`
        const new_subtree_content = {
          base_tree: subtree.sha,
          tree: [
            ...subtree.tree.filter(e => e.path !== 'logs.yaml' || e.type !== 'blob'),
            {
              path: 'logs.yaml',
              mode: '100644',
              type: 'blob',
              sha: new_blob.sha
            }
          ]
        }

        console.log(`save :: creating new subtree for _data/ with blob ${new_blob.sha}...`)
        res = await fetch(`https://mrvs.city/.netlify/git/github/git/trees`, {
          method: 'POST',
          headers,
          body: JSON.stringify(new_subtree_content)
        })
        const new_subtree = await res.json()

        if (!new_subtree.sha) throw `bad new tree ${JSON.stringify(new_subtree)}`
        const new_tree_content = {
          base_tree: tree.sha,
          tree: [
            ...tree.tree.filter(e => e.path !== '_data' || e.type !== 'tree'),
            {
              path: '_data',
              mode: '040000',
              type: 'tree',
              sha: new_subtree.sha
            }
          ]
        }

        console.log(`save :: creating new tree for commit with blob ${new_blob.sha}...`)
        res = await fetch(`https://mrvs.city/.netlify/git/github/git/trees`, {
          method: 'POST',
          headers,
          body: JSON.stringify(new_tree_content)
        })
        const new_tree = await res.json()

        if (!new_tree.sha) throw `bad new tree ${JSON.stringify(new_tree)}`
        const new_commit_content = {
          message: '* Update logs [auto]',
          tree: new_tree.sha,
          parents: [commit.sha],
          committer: {
            name: 'mrvsbot',
            email: 'bot@mrvs.city',
            date: (new Date()).toISOString()
          }
        }

        console.log(`save :: creating new commit for tree ${new_tree.sha}...`)
        res = await fetch(`https://mrvs.city/.netlify/git/github/git/commits`, {
          method: 'POST',
          headers,
          body: JSON.stringify(new_commit_content)
        })
        const new_commit = await res.json()

        if (!new_commit.sha) throw `bad new commit ${JSON.stringify(new_commit)}`
        console.log(`save :: updating ref master for commit ${new_commit.sha}...`)
        res = await fetch(`https://mrvs.city/.netlify/git/github/git/refs/heads/master`, {
          method: 'PATCH',
          headers,
          body: JSON.stringify({ sha: new_commit.sha })
        })
        const new_ref = await res.json()

        console.log('save :: done', new_ref)

        return data2
      }
      
      const updateSavable = () => {
        let saveEl = document.getElementById('save')

        if (Object.keys(savable).length && saveEl === null) {
          saveEl = document.createElement('input')
          saveEl.setAttribute('id', 'save')
          saveEl.setAttribute('type', 'button')
          saveEl.setAttribute('value', 'Save')

          saveEl.addEventListener('click', e => {
            if (!netlifyIdentity.currentUser()) netlifyIdentity.open()
            else {
              document.getElementById('toolbar').removeChild(saveEl)
              save(data, savable)
                .then(data2 => data = data2, savable = {})
                .catch(e => console.error(e), document.getElementById('toolbar').appendChild(saveEl))
            }
          })

          document.getElementById('toolbar').appendChild(saveEl)
        } else if (!Object.keys(savable).length && saveEl !== null) {
          document.getElementById('toolbar').removeChild(saveEl)
        }
      }

      netlifyIdentity.on('login', () => {
        logoutEl = document.createElement('input')
        logoutEl.setAttribute('id', 'logout')
        logoutEl.setAttribute('type', 'button')
        logoutEl.setAttribute('value', `Logout ${netlifyIdentity.currentUser().email}`)

        logoutEl.addEventListener('click', e => {
          document.getElementById('toolbar').removeChild(logoutEl)
          netlifyIdentity.logout()
        })

        document.getElementById('toolbar').insertBefore(logoutEl, document.getElementById('save'))
        netlifyIdentity.close()
      })
      netlifyIdentity.on('close', deque)

      const checkcb = force => e => {
        eque.push({
          target: e.target,
          set: { checked: !!e.target.checked },
          unset: { checked: !e.target.checked },
          force: !!force
        })

        e.target.indeterminate = true
        
        if (!netlifyIdentity.currentUser()) netlifyIdentity.open()
        else deque()
      }

      ;(() => {
        ;[].forEach.call(document.querySelectorAll('.data'), el => {
          if (!el.querySelector(`input[title="${ds}"]`)) {
            missingEl = document.createElement('input')
            missingEl.setAttribute('type', 'checkbox')
            missingEl.setAttribute('title', ds)
            missingEl.indeterminate = true
            missingEl.addEventListener('change', checkcb(true))
            el.insertBefore(missingEl, el.firstChild)
          }
        })

        ;[].forEach.call(document.querySelectorAll('.data input'), el => {
          if (!el.nextElementSibling) return
          
          let item = el.getAttribute('title')
          let next = el.nextElementSibling.getAttribute('title')
          item = new Date(item.slice(0, -4), parseInt(item.slice(-4, -2), 10) - 1, item.slice(-2))
          next = new Date(next.slice(0, -4), parseInt(next.slice(-4, -2), 10) - 1, next.slice(-2))

          while (item - next !== 86400000) {
            missing = new Date(item.valueOf() - 86400000)
            missingEl = document.createElement('input')
            missingEl.setAttribute('type', 'checkbox')
            missingEl.setAttribute('title', '' + missing.getUTCFullYear() + ('00' + (missing.getUTCMonth() + 1)).slice(-2) + ('00' + missing.getUTCDate()).slice(-2))
            missingEl.indeterminate = true
            missingEl.addEventListener('change', checkcb(true))
            el.parentNode.insertBefore(missingEl, el.nextElementSibling)
            item = missing
          }
        })
        ;[].forEach.call(document.querySelectorAll(`.data input[title="${ds}"]`), el => {
          el.removeAttribute('disabled')
          el.addEventListener('change', checkcb())
        })}
      )()
    </script>
  </body>
</html>